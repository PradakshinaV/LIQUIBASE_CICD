name: Database Migration Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Changesets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    - name: Validate Changelog
      run: |
        liquibase --url=offline:mysql --changeLogFile=liquibase/changelogs/db.changelog-master.xml validate

  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Set up MySQL
      uses: shogo82148/actions-setup-mysql@v1
      with:
        mysql-version: '8.0'
        root-password: 'root'
    
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h localhost -u root -proot --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
    
    - name: Create DEV Database
      run: |
        mysql -h localhost -u root -proot -e "CREATE DATABASE IF NOT EXISTS testdb_dev;"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'%' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_dev.* TO '${{ secrets.DB_USERNAME }}'@'localhost';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_dev.* TO '${{ secrets.DB_USERNAME }}'@'%';"
        mysql -h localhost -u root -proot -e "FLUSH PRIVILEGES;"
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    # üÜï NEW: Backup before deployment
    - name: Backup DEV Database
      run: |
        mkdir -p backups
        mysqldump -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_dev > backups/dev_backup_$(date +%Y%m%d_%H%M%S).sql || echo "No tables to backup"
      continue-on-error: true
    
    - name: Show Pending Changes
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_dev --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar status
    
    # üÜï UPDATED: Added id and continue-on-error
    - name: Deploy to DEV Database
      id: deploy_dev
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_dev --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar update
      continue-on-error: true
    
    # üÜï NEW: Automatic rollback on failure
    - name: Rollback on Failure
      if: failure() && steps.deploy_dev.outcome == 'failure'
      run: |
        echo "‚ö†Ô∏è Deployment failed! Initiating rollback..."
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_dev --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar rollback-count 1
        echo "‚úÖ Rollback completed"
    
    # üÜï UPDATED: Only runs if deployment succeeded
    - name: Verify DEV Deployment
      if: success()
      run: |
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_dev -e "SHOW TABLES;"
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_dev -e "SELECT ID, AUTHOR, FILENAME, DATEEXECUTED FROM DATABASECHANGELOG ORDER BY DATEEXECUTED DESC LIMIT 5;"
    
    # üÜï NEW: Upload backup as artifact
    - name: Upload Backup Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dev-backup
        path: backups/
        retention-days: 30

  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: 
      name: QA
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Set up MySQL
      uses: shogo82148/actions-setup-mysql@v1
      with:
        mysql-version: '8.0'
        root-password: 'root'
    
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h localhost -u root -proot --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
    
    - name: Create QA Database
      run: |
        mysql -h localhost -u root -proot -e "CREATE DATABASE IF NOT EXISTS testdb_qa;"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'%' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_qa.* TO '${{ secrets.DB_USERNAME }}'@'localhost';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_qa.* TO '${{ secrets.DB_USERNAME }}'@'%';"
        mysql -h localhost -u root -proot -e "FLUSH PRIVILEGES;"
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    # üÜï NEW: Backup before deployment
    - name: Backup QA Database
      run: |
        mkdir -p backups
        mysqldump -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_qa > backups/qa_backup_$(date +%Y%m%d_%H%M%S).sql || echo "No tables to backup"
      continue-on-error: true
    
    - name: Show Pending Changes
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_qa --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar status
    
    # üÜï UPDATED: Added id and continue-on-error
    - name: Deploy to QA Database
      id: deploy_qa
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_qa --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar update
      continue-on-error: true
    
    # üÜï NEW: Automatic rollback on failure
    - name: Rollback on Failure
      if: failure() && steps.deploy_qa.outcome == 'failure'
      run: |
        echo "‚ö†Ô∏è QA Deployment failed! Initiating rollback..."
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_qa --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar rollback-count 1
        echo "‚úÖ Rollback completed"
    
    # üÜï UPDATED: Only runs if deployment succeeded
    - name: Verify QA Deployment
      if: success()
      run: |
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_qa -e "SHOW TABLES;"
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_qa -e "SELECT ID, AUTHOR, FILENAME, DATEEXECUTED FROM DATABASECHANGELOG ORDER BY DATEEXECUTED DESC LIMIT 5;"
    
    # üÜï NEW: Upload backup as artifact
    - name: Upload Backup Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: qa-backup
        path: backups/
        retention-days: 30

  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy-qa
    environment: 
      name: PRODUCTION
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Set up MySQL
      uses: shogo82148/actions-setup-mysql@v1
      with:
        mysql-version: '8.0'
        root-password: 'root'
    
    
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h localhost -u root -proot --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
    
    - name: Create PROD Database
      run: |
        mysql -h localhost -u root -proot -e "CREATE DATABASE IF NOT EXISTS testdb_prod;"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'%' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_prod.* TO '${{ secrets.DB_USERNAME }}'@'localhost';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_prod.* TO '${{ secrets.DB_USERNAME }}'@'%';"
        mysql -h localhost -u root -proot -e "FLUSH PRIVILEGES;"
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    # üÜï ENHANCED: Better PROD backup with logging
    - name: Backup PROD Database (CRITICAL)
      run: |
        mkdir -p backups
        echo "üîí Creating PRODUCTION backup..."
        mysqldump -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_prod > backups/prod_backup_$(date +%Y%m%d_%H%M%S).sql || echo "No tables to backup"
        echo "‚úÖ Backup created successfully"
    
    - name: Show Pending Changes
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_prod --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar status
    
    # üÜï UPDATED: Added id, continue-on-error, and better logging
    - name: Deploy to PROD Database
      id: deploy_prod
      run: |
        cd $GITHUB_WORKSPACE
        echo "üöÄ Starting PRODUCTION deployment..."
        liquibase --url=jdbc:mysql://localhost:3306/testdb_prod --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar update
        echo "‚úÖ Deployment completed successfully"
      continue-on-error: true
    
    # üÜï NEW: Automatic rollback on failure with emergency messaging
    - name: Rollback on Failure
      if: failure() && steps.deploy_prod.outcome == 'failure'
      run: |
        echo "üö® PRODUCTION DEPLOYMENT FAILED! Initiating emergency rollback..."
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_prod --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar rollback-count 1
        echo "‚úÖ Rollback completed - PRODUCTION restored to previous state"
    
    # üÜï UPDATED: Only runs if deployment succeeded
    - name: Verify PROD Deployment
      if: success()
      run: |
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_prod -e "SHOW TABLES;"
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_prod -e "SELECT ID, AUTHOR, FILENAME, DATEEXECUTED FROM DATABASECHANGELOG ORDER BY DATEEXECUTED DESC LIMIT 5;"
    
    # üÜï NEW: Upload PROD backup with longer retention
    - name: Upload PROD Backup Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: prod-backup
        path: backups/
        retention-days: 90
    
    - name: Tag Production Release
      if: success()
      run: |
        echo "‚úÖ Production deployment completed successfully at $(date)"
        echo "üè∑Ô∏è Release tagged"