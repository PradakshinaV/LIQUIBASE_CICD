name: Liquibase Migration Pipeline

on:
  push:
    branches: [ main, test-validation ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      count:
        description: 'Number of changesets to rollback'
        required: true
        default: '1'
        type: string

jobs:
# =====================================================
# DEV
# =====================================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo liquibase.zip https://github.com/liquibase/liquibase/releases/download/v4.33.0/liquibase-4.33.0.zip
          unzip -q liquibase.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Install MySQL Connector
        run: |
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.1.0/mysql-connector-j-9.1.0.jar

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -uroot -proot && break
            sleep 2
          done

      - name: Validate Changelog
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            validate

      - name: Deploy to DEV
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            update

      - name: Show Deployment Status
        if: always()
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            status --verbose

# =====================================================
# QA
# =====================================================
  promote-qa:
    name: Promote to QA
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: qa

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_qa
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo liquibase.zip https://github.com/liquibase/liquibase/releases/download/v4.33.0/liquibase-4.33.0.zip
          unzip -q liquibase.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Install MySQL Connector
        run: |
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.1.0/mysql-connector-j-9.1.0.jar

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -uroot -proot && break
            sleep 2
          done

      - name: Deploy to QA
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_qa" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            update

# =====================================================
# PROD
# =====================================================
  promote-prod:
    name: Promote to PROD
    runs-on: ubuntu-latest
    needs: promote-qa
    environment: prod

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_prod
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo liquibase.zip https://github.com/liquibase/liquibase/releases/download/v4.33.0/liquibase-4.33.0.zip
          unzip -q liquibase.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Install MySQL Connector
        run: |
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.1.0/mysql-connector-j-9.1.0.jar

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -uroot -proot && break
            sleep 2
          done

      - name: Deploy to PROD
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_prod" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            update

      - name: Show Production Deployment History
        if: always()
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_prod" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            history

# =====================================================
# MANUAL ROLLBACK (Workflow Dispatch Only)
# =====================================================
  manual-rollback:
    name: Manual Rollback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment: 
      name: ${{ github.event.inputs.environment }}
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_${{ github.event.inputs.environment }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo liquibase.zip https://github.com/liquibase/liquibase/releases/download/v4.33.0/liquibase-4.33.0.zip
          unzip -q liquibase.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Install MySQL Connector
        run: |
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.1.0/mysql-connector-j-9.1.0.jar

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -uroot -proot && break
            sleep 2
          done

      - name: Execute Rollback
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_${{ github.event.inputs.environment }}" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            rollback-count ${{ github.event.inputs.count }}

      - name: Verify Rollback
        if: always()
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_${{ github.event.inputs.environment }}" \
            --username=root \
            --password=root \
            --changeLogFile=liquibase/changelogs/db.changelog-master.xml \
            --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar \
            status --verbose