name: Liquibase Migration Pipeline

on:
  push:
    branches: [ main, test-validation ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options: [dev, qa, prod]
      count:
        description: 'Number of changesets to rollback'
        required: true
        default: '1'

env:
  LIQUIBASE_VERSION: 4.33.0
  MYSQL_CONNECTOR_VERSION: 8.4.0

# =====================================================
# DEV
# =====================================================
jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4
      
      - name: Debug - Check repository contents
        run: |
          echo "=========================================="
          echo "Current directory:"
          pwd
          echo "=========================================="
          echo "Files in root:"
          ls -la
          echo "=========================================="
          echo "Looking for changelogs folder:"
          if [ -d "changelogs" ]; then
            echo "✓ changelogs folder EXISTS"
            echo "Contents of changelogs:"
            ls -la changelogs/
            echo "Contents of changelogs/v1.0:"
            ls -la changelogs/v1.0/
            echo "db.changelog-master.xml contents:"
            cat changelogs/db.changelog-master.xml
          else
            echo "✗ changelogs folder NOT FOUND"
            echo "Searching for changelogs anywhere:"
            find . -name "changelogs" -type d
            find . -name "db.changelog-master.xml"
          fi
          echo "=========================================="
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Install MySQL Connector
        run: |
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Wait for DB
        run: |
          sleep 10
          mysqladmin ping -h 127.0.0.1 -uroot -proot

      - name: Validate
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            validate

      - name: Deploy DEV
        run: |
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            update

# =====================================================
# QA
# =====================================================
  promote-qa:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: qa

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase + Driver
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Deploy QA
        run: |
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_QA }}:${{ secrets.DB_PORT_QA }}/testdb_qa" \
            --username=${{ secrets.DB_USER_QA }} \
            --password=${{ secrets.DB_PASS_QA }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            update

# =====================================================
# PROD
# =====================================================
  promote-prod:
    runs-on: ubuntu-latest
    needs: promote-qa
    environment: prod

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase + Driver
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Deploy PROD
        run: |
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_PROD }}:${{ secrets.DB_PORT_PROD }}/testdb_prod" \
            --username=${{ secrets.DB_USER_PROD }} \
            --password=${{ secrets.DB_PASS_PROD }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            update

# =====================================================
# MANUAL ROLLBACK
# =====================================================
  manual-rollback:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase + Driver
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Rollback
        run: |
          liquibase \
            --url="jdbc:mysql://${{ secrets[format('DB_HOST_{0}', github.event.inputs.environment)] }}:${{ secrets[format('DB_PORT_{0}', github.event.inputs.environment)] }}/testdb_${{ github.event.inputs.environment }}" \
            --username=${{ secrets[format('DB_USER_{0}', github.event.inputs.environment)] }} \
            --password=${{ secrets[format('DB_PASS_{0}', github.event.inputs.environment)] }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            rollback-count ${{ github.event.inputs.count }}