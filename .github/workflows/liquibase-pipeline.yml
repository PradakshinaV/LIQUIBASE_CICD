name: Liquibase Migration Pipeline (DEV)

on:
  push:
    branches: [ main, test-validation ]
  workflow_dispatch:
    inputs:
      rollback_count:
        description: 'Number of changesets to rollback in DEV'
        required: true
        default: '1'

env:
  LIQUIBASE_VERSION: 4.33.0
  MYSQL_CONNECTOR_VERSION: 8.4.0

# =====================================================
# DEV ENVIRONMENT
# =====================================================
jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Install MySQL Connector
        run: |
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Wait for MySQL to be ready
        run: |
          echo "‚è≥ Waiting for MySQL..."
          sleep 10
          mysqladmin ping -h 127.0.0.1 -uroot -proot --wait=30
          echo "‚úÖ MySQL is ready!"

      - name: Validate Changelog
        run: |
          echo "üîç Validating changelog..."
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            validate
          echo "‚úÖ Changelog is valid!"

      - name: Deploy to DEV
        run: |
          echo "üöÄ Deploying to DEV environment..."
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            update
          echo "‚úÖ DEV deployment complete!"

      - name: Show deployment summary
        run: |
          echo ""
          echo "=========================================="
          echo "üìä DEV Deployment Summary"
          echo "=========================================="
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            history || echo "No history available yet"
          echo "=========================================="
          echo ""
          echo "‚ú® Deployment successful! Check the database to verify changes."

# =====================================================
# MANUAL ROLLBACK (DEV)
# =====================================================
  rollback-dev:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase + Driver
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Wait for MySQL
        run: |
          echo "‚è≥ Waiting for MySQL..."
          sleep 10
          mysqladmin ping -h 127.0.0.1 -uroot -proot --wait=30
          echo "‚úÖ MySQL is ready!"

      - name: Show current state before rollback
        run: |
          echo ""
          echo "=========================================="
          echo "üìä Current State (Before Rollback)"
          echo "=========================================="
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            history || echo "No history available"
          echo "=========================================="
          echo ""

      - name: Rollback Changes
        run: |
          echo "‚èÆÔ∏è  Rolling back ${{ github.event.inputs.rollback_count }} changeset(s)..."
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            rollback-count ${{ github.event.inputs.rollback_count }}
          echo "‚úÖ Rollback complete!"

      - name: Show state after rollback
        run: |
          echo ""
          echo "=========================================="
          echo "üìä State After Rollback"
          echo "=========================================="
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            history || echo "No history available"
          echo "=========================================="
          echo ""
          echo "‚ú® Rollback successful! ${{ github.event.inputs.rollback_count }} changeset(s) removed."