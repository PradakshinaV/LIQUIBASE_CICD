name: Liquibase Migration Pipeline

on:
  push:
    branches: [ main, test-validation ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options: [dev, qa, prod]
      count:
        description: 'Number of changesets to rollback'
        required: true
        default: '1'

env:
  LIQUIBASE_VERSION: 4.33.0
  MYSQL_CONNECTOR_VERSION: 8.4.0

# =====================================================
# DEV ENVIRONMENT
# =====================================================
jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Install MySQL Connector
        run: |
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL..."
          sleep 10
          mysqladmin ping -h 127.0.0.1 -uroot -proot --wait=30
          echo "✓ MySQL is ready!"

      - name: Validate Changelog
        run: |
          echo "Validating changelog..."
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            validate
          echo "✓ Changelog is valid!"

      - name: Deploy to DEV
        run: |
          echo "Deploying to DEV environment..."
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            update
          echo "✓ DEV deployment complete!"

      - name: Show deployment status
        run: |
          echo "=========================================="
          echo "DEV Deployment Summary"
          echo "=========================================="
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            history

# =====================================================
# QA ENVIRONMENT
# =====================================================
  promote-qa:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: qa
    if: github.event_name == 'push'  # Only run on push, not on manual workflow_dispatch

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase + Driver
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Deploy to QA
        run: |
          echo "Deploying to QA environment..."
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_QA }}:${{ secrets.DB_PORT_QA }}/testdb_qa" \
            --username=${{ secrets.DB_USER_QA }} \
            --password=${{ secrets.DB_PASS_QA }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            update
          echo "✓ QA deployment complete!"

      - name: Show deployment status
        run: |
          echo "=========================================="
          echo "QA Deployment Summary"
          echo "=========================================="
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_QA }}:${{ secrets.DB_PORT_QA }}/testdb_qa" \
            --username=${{ secrets.DB_USER_QA }} \
            --password=${{ secrets.DB_PASS_QA }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            history

# =====================================================
# PROD ENVIRONMENT
# =====================================================
  promote-prod:
    runs-on: ubuntu-latest
    needs: promote-qa
    environment: prod
    if: github.event_name == 'push'  # Only run on push, not on manual workflow_dispatch

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase + Driver
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Deploy to PROD
        run: |
          echo "Deploying to PROD environment..."
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_PROD }}:${{ secrets.DB_PORT_PROD }}/testdb_prod" \
            --username=${{ secrets.DB_USER_PROD }} \
            --password=${{ secrets.DB_PASS_PROD }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            update
          echo "✓ PROD deployment complete!"

      - name: Show deployment status
        run: |
          echo "=========================================="
          echo "PROD Deployment Summary"
          echo "=========================================="
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_PROD }}:${{ secrets.DB_PORT_PROD }}/testdb_prod" \
            --username=${{ secrets.DB_USER_PROD }} \
            --password=${{ secrets.DB_PASS_PROD }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            history

# =====================================================
# MANUAL ROLLBACK (Any Environment)
# =====================================================
  manual-rollback:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    # For DEV, we need the MySQL service container
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase + Driver
        run: |
          curl -sLo lb.zip https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.zip
          unzip -q lb.zip -d $HOME/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH
          mkdir -p $HOME/liquibase/lib
          curl -sLo $HOME/liquibase/lib/mysql.jar \
            https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_CONNECTOR_VERSION}/mysql-connector-j-${MYSQL_CONNECTOR_VERSION}.jar

      - name: Wait for MySQL (DEV only)
        if: github.event.inputs.environment == 'dev'
        run: |
          echo "Waiting for MySQL..."
          sleep 10
          mysqladmin ping -h 127.0.0.1 -uroot -proot --wait=30

      - name: Rollback DEV
        if: github.event.inputs.environment == 'dev'
        run: |
          echo "Rolling back ${{ github.event.inputs.count }} changeset(s) in DEV..."
          liquibase \
            --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
            --username=root \
            --password=root \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            rollback-count ${{ github.event.inputs.count }}
          echo "✓ DEV rollback complete!"

      - name: Rollback QA
        if: github.event.inputs.environment == 'qa'
        run: |
          echo "Rolling back ${{ github.event.inputs.count }} changeset(s) in QA..."
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_QA }}:${{ secrets.DB_PORT_QA }}/testdb_qa" \
            --username=${{ secrets.DB_USER_QA }} \
            --password=${{ secrets.DB_PASS_QA }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            rollback-count ${{ github.event.inputs.count }}
          echo "✓ QA rollback complete!"

      - name: Rollback PROD
        if: github.event.inputs.environment == 'prod'
        run: |
          echo "Rolling back ${{ github.event.inputs.count }} changeset(s) in PROD..."
          liquibase \
            --url="jdbc:mysql://${{ secrets.DB_HOST_PROD }}:${{ secrets.DB_PORT_PROD }}/testdb_prod" \
            --username=${{ secrets.DB_USER_PROD }} \
            --password=${{ secrets.DB_PASS_PROD }} \
            --classpath=$HOME/liquibase/lib/mysql.jar \
            --changeLogFile=changelogs/db.changelog-master.xml \
            rollback-count ${{ github.event.inputs.count }}
          echo "✓ PROD rollback complete!"

      - name: Show rollback status
        run: |
          echo "=========================================="
          echo "Rollback Summary - ${{ github.event.inputs.environment }} environment"
          echo "=========================================="
          if [ "${{ github.event.inputs.environment }}" == "dev" ]; then
            liquibase \
              --url="jdbc:mysql://127.0.0.1:3306/testdb_dev" \
              --username=root \
              --password=root \
              --classpath=$HOME/liquibase/lib/mysql.jar \
              --changeLogFile=changelogs/db.changelog-master.xml \
              history
          elif [ "${{ github.event.inputs.environment }}" == "qa" ]; then
            liquibase \
              --url="jdbc:mysql://${{ secrets.DB_HOST_QA }}:${{ secrets.DB_PORT_QA }}/testdb_qa" \
              --username=${{ secrets.DB_USER_QA }} \
              --password=${{ secrets.DB_PASS_QA }} \
              --classpath=$HOME/liquibase/lib/mysql.jar \
              --changeLogFile=changelogs/db.changelog-master.xml \
              history
          else
            liquibase \
              --url="jdbc:mysql://${{ secrets.DB_HOST_PROD }}:${{ secrets.DB_PORT_PROD }}/testdb_prod" \
              --username=${{ secrets.DB_USER_PROD }} \
              --password=${{ secrets.DB_PASS_PROD }} \
              --classpath=$HOME/liquibase/lib/mysql.jar \
              --changeLogFile=changelogs/db.changelog-master.xml \
              history
          fi