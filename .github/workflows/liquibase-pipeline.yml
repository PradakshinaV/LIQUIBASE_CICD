name: Database Migration Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Changesets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    - name: Validate Changelog
      run: |
        liquibase --url=offline:mysql --changeLogFile=liquibase/changelogs/db.changelog-master.xml validate

  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Set up MySQL
      uses: shogo82148/actions-setup-mysql@v1
      with:
        mysql-version: '8.0'
        root-password: 'root'
    
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h localhost -u root -proot --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
    
    - name: Create DEV Database
      run: |
        mysql -h localhost -u root -proot -e "CREATE DATABASE IF NOT EXISTS testdb_dev;"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'%' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_dev.* TO '${{ secrets.DB_USERNAME }}'@'localhost';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_dev.* TO '${{ secrets.DB_USERNAME }}'@'%';"
        mysql -h localhost -u root -proot -e "FLUSH PRIVILEGES;"
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    - name: Show Pending Changes
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_dev --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar status
    
    - name: Deploy to DEV Database
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_dev --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar update
    
    - name: Verify DEV Deployment
      run: |
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_dev -e "SHOW TABLES;"
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_dev -e "SELECT ID, AUTHOR, FILENAME, DATEEXECUTED FROM DATABASECHANGELOG ORDER BY DATEEXECUTED DESC LIMIT 5;"

  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: 
      name: QA
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Set up MySQL
      uses: shogo82148/actions-setup-mysql@v1
      with:
        mysql-version: '8.0'
        root-password: 'root'
    
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h localhost -u root -proot --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
    
    - name: Create QA Database
      run: |
        mysql -h localhost -u root -proot -e "CREATE DATABASE IF NOT EXISTS testdb_qa;"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'%' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_qa.* TO '${{ secrets.DB_USERNAME }}'@'localhost';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_qa.* TO '${{ secrets.DB_USERNAME }}'@'%';"
        mysql -h localhost -u root -proot -e "FLUSH PRIVILEGES;"
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    - name: Show Pending Changes
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_qa --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar status
    
    - name: Deploy to QA Database
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_qa --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar update
    
    - name: Verify QA Deployment
      run: |
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_qa -e "SHOW TABLES;"
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_qa -e "SELECT ID, AUTHOR, FILENAME, DATEEXECUTED FROM DATABASECHANGELOG ORDER BY DATEEXECUTED DESC LIMIT 5;"

  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy-qa
    environment: 
      name: PRODUCTION
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Set up MySQL
      uses: shogo82148/actions-setup-mysql@v1
      with:
        mysql-version: '8.0'
        root-password: 'root'
    
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h localhost -u root -proot --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
    
    - name: Create PROD Database
      run: |
        mysql -h localhost -u root -proot -e "CREATE DATABASE IF NOT EXISTS testdb_prod;"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USERNAME }}'@'%' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_prod.* TO '${{ secrets.DB_USERNAME }}'@'localhost';"
        mysql -h localhost -u root -proot -e "GRANT ALL PRIVILEGES ON testdb_prod.* TO '${{ secrets.DB_USERNAME }}'@'%';"
        mysql -h localhost -u root -proot -e "FLUSH PRIVILEGES;"
    
    - name: Download and Setup Liquibase
      run: |
        cd /tmp
        wget -q https://github.com/liquibase/liquibase/releases/download/v4.23.0/liquibase-4.23.0.tar.gz
        tar -xzf liquibase-4.23.0.tar.gz
        chmod +x liquibase
        echo "/tmp" >> $GITHUB_PATH
    
    - name: Download MySQL Connector
      run: |
        mkdir -p liquibase/lib
        wget -q -O liquibase/lib/mysql-connector-j-9.4.0.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.4.0/mysql-connector-j-9.4.0.jar
    
    - name: Backup PROD Database
      run: |
        mysqldump -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_prod > prod_backup_$(date +%Y%m%d_%H%M%S).sql || echo "No tables to backup yet"
    
    - name: Show Pending Changes
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_prod --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar status
    
    - name: Deploy to PROD Database
      run: |
        cd $GITHUB_WORKSPACE
        liquibase --url=jdbc:mysql://localhost:3306/testdb_prod --username=${{ secrets.DB_USERNAME }} --password=${{ secrets.DB_PASSWORD }} --changeLogFile=liquibase/changelogs/db.changelog-master.xml --classpath=liquibase/lib/mysql-connector-j-9.4.0.jar update
    
    - name: Verify PROD Deployment
      run: |
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_prod -e "SHOW TABLES;"
        mysql -h localhost -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} testdb_prod -e "SELECT ID, AUTHOR, FILENAME, DATEEXECUTED FROM DATABASECHANGELOG ORDER BY DATEEXECUTED DESC LIMIT 5;"
    
    - name: Tag Production Release
      run: |
        echo "Production deployment completed successfully at $(date)"