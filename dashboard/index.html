<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquibase Migration Dashboard</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo-section">
                    <div class="logo-icon">üóÇÔ∏è</div>
                    <div>
                        <h1>Liquibase Dashboard</h1>
                        <p>Monitor and manage database schema changes across all environments</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div id="connectionStatus" class="connection-status disconnected">
                    <span class="status-dot red"></span>
                    <span>Disconnected</span>
                </div>
                <button class="refresh-btn" onclick="refreshAllData()" id="refreshBtn">
                    <span>‚Üª</span>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <!-- Top navigation panel (Apple-inspired) -->
        <nav class="top-nav">
            <button class="top-nav-button" onclick="viewHistory('dev')">View DEV History</button>
            <button class="top-nav-button" onclick="viewHistory('qa')">View QA History</button>
            <button class="top-nav-button" onclick="viewHistory('prod')">View PROD History</button>
            <button class="top-nav-button" onclick="compareEnvironments()">Compare Environments</button>
            <button class="top-nav-button" onclick="toggleRollbackSection()">Show Rollback Options</button>
        </nav>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Changesets</div>
                <div class="stat-value" id="totalChangesets">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle">Across all versions</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Environments</div>
                <div class="stat-value" id="healthyEnvs">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle">Healthy / Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last Deployment</div>
                <div class="stat-value" id="lastDeploy">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle" id="lastDeployEnv">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value" id="successRate">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle">Last 30 days</div>
            </div>
        </div>

        <!-- Environment Status -->
        <div class="environments-section">
            <h2 class="section-title">üìä Environment Status</h2>
            <div class="env-grid" id="envGrid">
                <div class="loading-spinner" style="margin: 50px auto;"></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" id="tabNavigation">
            <button class="tab-button active" data-tab="overview" onclick="switchTab('overview')">Overview</button>
            <button class="tab-button" data-tab="metrics" onclick="switchTab('metrics')">Metrics</button>
            <button class="tab-button" data-tab="version-map" onclick="switchTab('version-map')">Version Map</button>
            <button class="tab-button" data-tab="rollback-history" onclick="switchTab('rollback-history')">Rollback History</button>
            <button class="tab-button" data-tab="recent-deployments" onclick="switchTab('recent-deployments')">Recent Deployments</button>
        </div>

        <!-- Tab Content: Overview -->
        <div id="overviewTab" class="tab-content active">
            <div class="overview-layout">
                <div class="overview-left">
                    <h3 class="tab-section-title">Pending Migrations (<span id="selectedEnvDisplay">DEV</span>)</h3>
                    <div id="pendingMigrations" class="pending-migrations-container">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="overview-right">
                    <h3 class="tab-section-title">Migration History (<span id="selectedEnvDisplayHistory">DEV</span>)</h3>
                    <div id="migrationTimeline" class="timeline-container">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Metrics -->
        <div id="metricsTab" class="tab-content">
            <div id="metricsDashboard" class="metrics-container">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Tab Content: Version Map -->
        <div id="version-mapTab" class="tab-content">
            <div id="versionMap" class="version-map-container">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Tab Content: Rollback History -->
        <div id="rollback-historyTab" class="tab-content">
            <div id="rollbackHistory" class="rollback-history-container">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Tab Content: Recent Deployments -->
        <div id="recent-deploymentsTab" class="tab-content">
            <div id="recentDeployments" class="recent-deployments-container">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Rollback Section (hidden by default, shown via Show Rollback Options) -->
        <div class="actions-section" style="display: none;" id="rollbackSectionContainer">
            <h2 class="section-title">Rollback</h2>
            <div class="rollback-section" id="rollbackSection">
                <div class="rollback-warning">
                    ‚ö†Ô∏è DANGER ZONE: Database Rollback
                </div>
                <p style="color: #856404; margin-bottom: 15px;">
                    This will undo the last database changes. This action cannot be undone automatically.
                </p>
                <div class="rollback-controls">
                    <label style="font-weight: 600;">Environment:</label>
                    <select id="rollbackEnv" class="filter-select">
                        <option value="dev">DEV</option>
                        <option value="qa">QA</option>
                        <option value="prod">PROD</option>
                    </select>
                    
                    <label style="font-weight: 600;">Changesets to rollback:</label>
                    <input type="number" id="rollbackCount" class="rollback-input" value="1" min="1" max="10">
                    
                    <button class="rollback-btn" onclick="initiateRollback()">
                        ‚èÆÔ∏è Rollback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rollback Confirmation Dialog - OUTSIDE container -->
    <div id="rollbackConfirm" class="confirm-dialog" style="display: none;">
        <h3>‚ö†Ô∏è Confirm Rollback</h3>
        <div id="rollbackConfirmText"></div>
        <div class="confirm-buttons">
            <button class="confirm-yes" onclick="executeRollback()">Yes, Rollback</button>
            <button class="confirm-no" onclick="cancelRollback()">Cancel</button>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Migration History</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="search-filter-section">
                <input type="text" id="historySearch" class="search-box"
                       placeholder="üîç Search by ID, author, or description..." oninput="filterHistory()">
                <select id="historyFilter" class="filter-select" onchange="filterHistory()">
                    <option value="all">All Types</option>
                    <option value="EXECUTED">Executed</option>
                    <option value="RERAN">Re-ran</option>
                    <option value="ROLLBACK">Rollback</option>
                </select>
            </div>

            <div id="modalBody">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div class="modal" id="compareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Environment Comparison</h2>
                <button class="close-btn" onclick="closeCompareModal()">&times;</button>
            </div>
            <div id="compareBody">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Liquibase CI/CD Dashboard | Last updated: <span id="lastUpdateTime">Never</span></p>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let environmentsData = [];
        let autoRefreshInterval = null;
        let currentHistoryData = [];
        let rollbackEnvSelected = 'dev';
        let rollbackCountSelected = 1;
        let selectedEnv = 'dev';
        let activeTab = 'overview';
        let refreshKey = 0;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            refreshAllData();
            startAutoRefresh();
            loadTabContent(activeTab);
        });

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                refreshAllData();
                loadTabContent(activeTab);
            }, 15000); // 15 seconds as per Dashboard.jsx
        }

        // Tab switching functionality
        function switchTab(tabName) {
            activeTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const activeTabElement = document.getElementById(tabName + 'Tab');
            if (activeTabElement) {
                activeTabElement.classList.add('active');
            }
            
            // Load tab content
            loadTabContent(tabName);
        }

        function loadTabContent(tabName) {
            switch(tabName) {
                case 'overview':
                    loadPendingMigrations();
                    loadMigrationTimeline();
                    break;
                case 'metrics':
                    loadMetricsDashboard();
                    break;
                case 'version-map':
                    loadVersionMap();
                    break;
                case 'rollback-history':
                    loadRollbackHistory();
                    break;
                case 'recent-deployments':
                    loadRecentDeployments();
                    break;
            }
        }

        // Environment selection
        function selectEnvironment(env) {
            selectedEnv = env;
            document.getElementById('selectedEnvDisplay').textContent = env.toUpperCase();
            document.getElementById('selectedEnvDisplayHistory').textContent = env.toUpperCase();
            
            // Update environment cards visual state
            document.querySelectorAll('.env-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Refresh overview tab if active
            if (activeTab === 'overview') {
                loadPendingMigrations();
                loadMigrationTimeline();
            }
        }

        async function refreshAllData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            
            // First check if API server is reachable
            let apiReachable = false;
            try {
                const healthCheck = await fetch(`${API_BASE.replace('/api', '')}/health`);
                if (healthCheck.ok) {
                    apiReachable = true;
                }
            } catch (e) {
                console.error('API server health check failed:', e);
            }
            
            if (!apiReachable) {
                updateConnectionStatus(false, 'API server not reachable. Is the backend running on port 3000?');
                document.getElementById('lastUpdateTime').textContent = 'Connection failed';
                document.getElementById('envGrid').innerHTML = `
                    <div class="error-message" style="padding: 20px; text-align: center;">
                        <h3>‚ö†Ô∏è Cannot Connect to API Server</h3>
                        <p><strong>Error:</strong> API server not reachable at ${API_BASE.replace('/api', '')}</p>
                        <p style="margin-top: 15px;"><strong>Troubleshooting Steps:</strong></p>
                        <ol style="text-align: left; display: inline-block; margin-top: 10px;">
                            <li>Make sure the backend server is running:<br>
                                <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">cd dashboard/backend && npm start</code>
                            </li>
                            <li>Verify the server is running on port 3000</li>
                            <li>Check the API URL: <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">${API_BASE}</code></li>
                            <li>Check browser console (F12) for detailed errors</li>
                        </ol>
                    </div>
                `;
                btn.disabled = false;
                return;
            }
            
            try {
                const results = await Promise.allSettled([
                    loadEnvironments(),
                    loadStats(),
                    loadHistory()
                ]);
                
                // Check if at least one succeeded
                const hasSuccess = results.some(r => r.status === 'fulfilled');
                
                if (hasSuccess) {
                    updateConnectionStatus(true);
                    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
                } else {
                    updateConnectionStatus(false, 'Failed to load data from API');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                updateConnectionStatus(false, error.message || 'Unknown error');
            } finally {
                btn.disabled = false;
            }
        }

        function updateConnectionStatus(connected, errorMessage = '') {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<span class="status-dot green"></span><span>Connected</span>';
                statusEl.title = 'Connected to API server';
            } else {
                statusEl.className = 'connection-status disconnected';
                const message = errorMessage || 'Disconnected';
                statusEl.innerHTML = `<span class="status-dot red"></span><span>Disconnected</span>`;
                statusEl.title = message + '\n\nTroubleshooting:\n1. Check if backend server is running: npm start in dashboard/backend\n2. Verify API_BASE URL: ' + API_BASE + '\n3. Check browser console for errors';
            }
        }

        async function loadEnvironments() {
            try {
                const response = await fetch(`${API_BASE}/environments`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    environmentsData = data.environments;
                    renderEnvironments(data.environments);
                } else {
                    throw new Error(data.error || 'Failed to load environments');
                }
            } catch (error) {
                console.error('Error loading environments:', error);
                const errorMsg = error.message || 'Failed to load environment data';
                document.getElementById('envGrid').innerHTML = 
                    `<div class="error-message">
                        <strong>Failed to load environment data</strong><br>
                        <small>${errorMsg}</small><br>
                        <small style="color: #666;">Check if backend server is running on ${API_BASE.replace('/api', '')}</small>
                    </div>`;
                throw error; // Re-throw so Promise.allSettled can catch it
            }
        }

        // Modal dialog function
        function showModalDialog(title, content, isError) {
            // Remove existing modal if any
            const existingModal = document.getElementById('resultModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'resultModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background-color: white; padding: 24px; border-radius: 8px; max-width: 80%; max-height: 80%; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 12px;">
                        <h3 style="margin: 0; color: ${isError ? '#d32f2f' : '#2e7d32'};">${title}</h3>
                        <button onclick="closeModalDialog()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <div style="flex: 1; overflow: auto; padding: 12px; background-color: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; word-break: break-word; max-height: 60vh; border: 1px solid ${isError ? '#ffcdd2' : '#c8e6c9'};">
                        ${content}
                    </div>
                    <div style="margin-top: 16px; text-align: right;">
                        <button onclick="closeModalDialog()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModalDialog();
                }
            };
            
            document.body.appendChild(modal);
        }

        function closeModalDialog() {
            const modal = document.getElementById('resultModal');
            if (modal) {
                modal.remove();
            }
        }

        function renderEnvironments(environments) {
            const grid = document.getElementById('envGrid');
            grid.innerHTML = '';

            const icons = { dev: 'üîß', qa: 'üß™', prod: 'üöÄ' };
            const names = { dev: 'DEVELOPMENT', qa: 'QA', prod: 'PRODUCTION' };

            environments.forEach(env => {
                const card = document.createElement('div');
                card.className = 'env-card';
                if (selectedEnv === env.environment) {
                    card.classList.add('selected');
                }
                
                card.onclick = () => selectEnvironment(env.environment);
                card.style.cursor = 'pointer';
                card.style.border = selectedEnv === env.environment ? '2px solid #007bff' : '1px solid #ddd';
                card.style.backgroundColor = selectedEnv === env.environment ? '#f0f7ff' : 'white';
                card.style.transition = 'all 0.2s';
                
                // Get DB status
                const dbStatus = env.status === 'healthy' ? { ok: true } : { ok: false, error: env.error || 'Not connected' };
                const statusColor = dbStatus.ok ? '#2e7d32' : '#d32f2f';
                const statusText = dbStatus.ok ? '‚úÖ Connected' : 'üî¥ Down';
                
                // Get latest changeset
                const latest = env.latestChangeset ? {
                    id: env.latestChangeset.id,
                    author: env.latestChangeset.author,
                    dateexecuted: env.lastUpdated
                } : null;
                
                let statusClass, statusTextBadge;
                if (env.status === 'healthy') {
                    statusClass = 'status-healthy';
                    statusTextBadge = '‚óè Connected';
                } else if (env.status === 'uninitialized') {
                    statusClass = 'status-warning';
                    statusTextBadge = '‚óè Uninitialized';
                } else {
                    statusClass = 'status-error';
                    statusTextBadge = '‚óè Not Connected';
                }
                
                // Show error message if uninitialized
                const errorMsg = env.status === 'uninitialized' ? 
                    `<div class="env-error-msg" style="margin-top: 8px; font-size: 0.85rem; color: #854d0e;">
                        ${env.error || 'Run Liquibase update to initialize'}
                    </div>` : '';
                
                const lastUpdated = env.lastUpdated 
                    ? formatTimeAgo(new Date(env.lastUpdated))
                    : 'Never';

                card.innerHTML = `
                    <div class="env-header">
                        <div class="env-name" style="text-transform: uppercase; margin-top: 0; color: ${selectedEnv === env.environment ? '#007bff' : '#333'};">
                            ${icons[env.environment]} ${names[env.environment]}
                        </div>
                        <span class="status-badge ${statusClass}">${statusTextBadge}</span>
                    </div>
                    <div class="env-info" style="margin-top: 12px;">
                        <div style="margin-bottom: 8px;">
                            DB status: <strong style="color: ${statusColor};">${statusText}</strong>
                            ${dbStatus && !dbStatus.ok && dbStatus.error ? `
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">${dbStatus.error}</div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 8px; font-size: 13px; color: #666;">
                            ${latest ? `
                                <div><strong>Last change:</strong> ${latest.id}</div>
                                <div style="margin-top: 4px;">by ${latest.author}</div>
                                <div style="font-size: 11px; color: #888;">
                                    ${latest.dateexecuted ? new Date(latest.dateexecuted).toLocaleString() : 'N/A'}
                                </div>
                            ` : '<div>No migrations applied</div>'}
                        </div>
                        <div class="info-row" style="margin-top: 8px;">
                            <span class="info-label">Current Version</span>
                            <span class="version-badge">${env.currentVersion || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Changesets Applied</span>
                            <span class="info-value">${env.changesetsApplied || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Last Updated</span>
                            <span class="info-value">${lastUpdated}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Database</span>
                            <span class="info-value">${env.database || 'N/A'}</span>
                        </div>
                        ${errorMsg}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    document.getElementById('totalChangesets').textContent = stats.totalChangesets;
                    document.getElementById('healthyEnvs').textContent = 
                        `${stats.healthyEnvironments} / ${stats.totalEnvironments}`;
                    document.getElementById('successRate').textContent = `${stats.successRate}%`;
                    
                    if (stats.lastDeployment) {
                        document.getElementById('lastDeploy').textContent = stats.lastDeployment.formatted;
                        document.getElementById('lastDeployEnv').textContent = 'to PROD';
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadHistory() {
            // This function is kept for compatibility but doesn't render to a specific element
            // The timeline is loaded separately via loadMigrationTimeline() when the overview tab is active
            try {
                const response = await fetch(`${API_BASE}/migrations/history?env=dev&limit=5`);
                const data = await response.json();
                
                if (data.success) {
                    // History loaded successfully, but we don't render it here
                    // It's rendered in loadMigrationTimeline() when needed
                    return;
                }
            } catch (error) {
                console.error('Error loading history:', error);
                // Don't try to render to a non-existent element
            }
        }

        function renderTimeline(history) {
            // This function is deprecated - use renderTimelineForTab instead
            // Keeping for backward compatibility but it won't render anything
            const timeline = document.getElementById('timeline');
            if (!timeline) {
                // Element doesn't exist, which is expected in the new structure
                return;
            }
            
            timeline.innerHTML = '';

            if (!history || history.length === 0) {
                timeline.innerHTML = '<p style="text-align:center;color:#666;">No migration history available</p>';
                return;
            }

            history.forEach(item => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                const timeAgo = formatTimeAgo(new Date(item.DATEEXECUTED));
                
                timelineItem.innerHTML = `
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-title">${item.ID}</span>
                            <span class="timeline-time">${timeAgo}</span>
                        </div>
                        <div class="timeline-desc">
                            <strong>Author:</strong> ${item.AUTHOR}<br>
                            <strong>Description:</strong> ${item.DESCRIPTION || 'No description'}<br>
                            <strong>File:</strong> ${item.FILENAME}<br>
                            <strong>Status:</strong> ‚úÖ ${item.EXECTYPE}
                        </div>
                    </div>
                `;
                
                timeline.appendChild(timelineItem);
            });
        }

        async function viewHistory(env) {
            const modal = document.getElementById('historyModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            const envNames = { dev: 'DEV', qa: 'QA', prod: 'PROD' };
            modalTitle.textContent = `${envNames[env]} Migration History`;
            
            modal.classList.add('show');
            modalBody.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const response = await fetch(`${API_BASE}/migrations/history?env=${env}&limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    currentHistoryData = data.history;
                    renderHistoryItems(data.history);
                } else {
                    modalBody.innerHTML = '<div class="error-message">Failed to load history</div>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                modalBody.innerHTML = '<div class="error-message">Error loading history: ' + error.message + '</div>';
            }
        }

        function renderHistoryItems(history) {
            const modalBody = document.getElementById('modalBody');
            let html = '';
            
            if (history.length === 0) {
                html = '<p style="text-align:center;color:#666;">No migration history found</p>';
            } else {
                history.forEach(item => {
                    const execTypeBadge = item.EXECTYPE === 'EXECUTED' ? 'badge-success' : 
                                        item.EXECTYPE === 'RERAN' ? 'badge-warning' : 
                                        'badge-info';
                    
                    html += `
                        <div class="history-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4>${item.ID}</h4>
                                <span class="badge ${execTypeBadge}">${item.EXECTYPE}</span>
                            </div>
                            <p><strong>Author:</strong> ${item.AUTHOR}</p>
                            <p><strong>Executed:</strong> ${new Date(item.DATEEXECUTED).toLocaleString()}</p>
                            <p><strong>Description:</strong> ${item.DESCRIPTION || 'No description'}</p>
                            <p><strong>File:</strong> ${item.FILENAME}</p>
                            <p><strong>Order:</strong> #${item.ORDEREXECUTED}</p>
                        </div>
                    `;
                });
            }
            
            modalBody.innerHTML = html;
        }

        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const filterType = document.getElementById('historyFilter').value;
            
            let filtered = currentHistoryData;
            
            if (filterType !== 'all') {
                filtered = filtered.filter(item => item.EXECTYPE === filterType);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.ID.toLowerCase().includes(searchTerm) ||
                    item.AUTHOR.toLowerCase().includes(searchTerm) ||
                    (item.DESCRIPTION && item.DESCRIPTION.toLowerCase().includes(searchTerm)) ||
                    item.FILENAME.toLowerCase().includes(searchTerm)
                );
            }
            
            renderHistoryItems(filtered);
        }

        async function compareEnvironments() {
            const modal = document.getElementById('compareModal');
            const compareBody = document.getElementById('compareBody');
            
            modal.classList.add('show');
            compareBody.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const response = await fetch(`${API_BASE}/migrations/diff?env1=dev&env2=prod`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<h3>Schema Comparison: DEV vs PROD</h3>';
                    
                    html += `
                        <div style="margin: 20px 0;">
                            <p><strong>DEV:</strong> ${data.environment1.totalChangesets} changesets</p>
                            <p><strong>PROD:</strong> ${data.environment2.totalChangesets} changesets</p>
                        </div>
                    `;
                    
                    if (data.differences.identical) {
                        html += '<div class="success-message">‚úÖ Environments are identical</div>';
                    } else {
                        if (data.differences.onlyIn.dev.length > 0) {
                            html += '<h4 style="color:#667eea;margin-top:20px;">Only in DEV:</h4>';
                            html += '<ul>';
                            data.differences.onlyIn.dev.forEach(id => {
                                html += `<li>${id}</li>`;
                            });
                            html += '</ul>';
                        }
                        
                        if (data.differences.onlyIn.prod.length > 0) {
                            html += '<h4 style="color:#667eea;margin-top:20px;">Only in PROD:</h4>';
                            html += '<ul>';
                            data.differences.onlyIn.prod.forEach(id => {
                                html += `<li>${id}</li>`;
                            });
                            html += '</ul>';
                        }
                    }
                    
                    compareBody.innerHTML = html;
                } else {
                    compareBody.innerHTML = '<div class="error-message">Failed to compare environments</div>';
                }
            } catch (error) {
                console.error('Error comparing environments:', error);
                compareBody.innerHTML = '<div class="error-message">Error: ' + error.message + '</div>';
            }
        }

        function closeModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        function closeCompareModal() {
            document.getElementById('compareModal').classList.remove('show');
        }

        window.onclick = function(event) {
            const historyModal = document.getElementById('historyModal');
            const compareModal = document.getElementById('compareModal');
            
            if (event.target === historyModal) {
                closeModal();
            }
            if (event.target === compareModal) {
                closeCompareModal();
            }
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
                }
            }
            
            return 'Just now';
        }

        // ===== ROLLBACK FUNCTIONS - FINAL FIXED VERSION =====

        function toggleRollbackSection() {
            const section = document.getElementById('rollbackSection');
            const confirmDialog = document.getElementById('rollbackConfirm');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (confirmDialog) confirmDialog.style.display = 'none';
            } else {
                section.style.display = 'none';
                if (confirmDialog) confirmDialog.style.display = 'none';
            }
        }

     // Replace these functions in your index.html <script> section

async function initiateRollback() {
    const env = document.getElementById('rollbackEnv').value;
    const count = parseInt(document.getElementById('rollbackCount').value);
    
    rollbackEnvSelected = env;
    rollbackCountSelected = count;
    
    // First, get preview of what will be rolled back
    try {
        const response = await fetch(`${API_BASE}/migrations/rollback-preview?env=${env}&count=${count}`);
        const previewData = await response.json();
        
        if (!previewData.success) {
            alert('Error getting rollback preview: ' + previewData.error);
            return;
        }

        const confirmDialog = document.getElementById('rollbackConfirm');
        const confirmText = document.getElementById('rollbackConfirmText');
        
        const envNames = { dev: 'DEVELOPMENT', qa: 'QA', prod: 'PRODUCTION' };
        
        let html = `
            <p><strong>‚ö†Ô∏è You are about to rollback ${count} changeset(s) from ${envNames[env]}</strong></p>
        `;
        
        if (env === 'prod') {
            html += `<div class="prod-warning">‚ö†Ô∏è CRITICAL: THIS IS PRODUCTION ENVIRONMENT!</div>`;
        }
        
        html += `<div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin-bottom: 10px;">Changesets to be rolled back:</h4>`;
        
        previewData.changesetsToRollback.forEach((cs, index) => {
            html += `
                <div style="padding: 8px; margin: 5px 0; background: white; border-left: 3px solid #dc3545; border-radius: 4px;">
                    <strong>${index + 1}. ${cs.ID}</strong><br>
                    <small>Author: ${cs.AUTHOR} | ${new Date(cs.DATEEXECUTED).toLocaleString()}</small><br>
                    <small>${cs.DESCRIPTION || 'No description'}</small>
                </div>
            `;
        });
        
        html += `</div>
            <p style="color: #721c24; font-weight: 600; margin-top: 15px;">
                ‚ö†Ô∏è This action CANNOT be undone automatically. Make sure you have a backup!
            </p>
            <p style="color: #856404;">
                Current changesets: ${previewData.changesetsToRollback[0]?.ORDEREXECUTED || 'Unknown'} ‚Üí 
                After rollback: ${(previewData.changesetsToRollback[0]?.ORDEREXECUTED || 0) - count}
            </p>`;
        
        confirmText.innerHTML = html;
        confirmDialog.style.display = 'block';
        confirmDialog.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function executeRollback() {
    const confirmDialog = document.getElementById('rollbackConfirm');
    confirmDialog.innerHTML = `
        <div style="text-align: center; padding: 30px;">
            <div class="loading-spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
            <h3>Executing Rollback...</h3>
            <p style="color: #666;">Please wait. This may take a few moments.</p>
        </div>
    `;
    
    try {
        const response = await fetch(`${API_BASE}/migrations/rollback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                env: rollbackEnvSelected,
                count: rollbackCountSelected
            })
        });

        const data = await response.json();
        
        if (data.success) {
            confirmDialog.innerHTML = `
                <div class="success-message">
                    <h3>‚úÖ Rollback Completed Successfully</h3>
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p><strong>Environment:</strong> ${data.environment.toUpperCase()}</p>
                        <p><strong>Changesets Rolled Back:</strong> ${data.changesetsRolledBack}</p>
                        <p><strong>Before:</strong> ${data.changesetsBefore} changesets</p>
                        <p><strong>After:</strong> ${data.changesetsAfter} changesets</p>
                        ${data.currentChangeset ? `
                            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                                <strong>Current Changeset:</strong><br>
                                ${data.currentChangeset.ID}<br>
                                <small>by ${data.currentChangeset.AUTHOR}</small>
                            </div>
                        ` : ''}
                    </div>
                    <details style="margin: 15px 0;">
                        <summary style="cursor: pointer; font-weight: 600; color: #667eea;">
                            View Command Output
                        </summary>
                        <pre style="background: #f4f4f4; padding: 15px; border-radius: 6px; overflow-x: auto; margin-top: 10px; font-size: 0.85em;">
${data.output || 'No output available'}</pre>
                    </details>
                    <button class="confirm-no" onclick="closeRollbackSection()" style="margin-top: 15px;">
                        Close
                    </button>
                </div>
            `;
            
            // Refresh dashboard data
            setTimeout(() => handleMigrationComplete(), 1500);
        } else {
            throw new Error(data.error || 'Rollback failed');
        }
        
    } catch (error) {
        confirmDialog.innerHTML = `
            <div class="error-message">
                <h3>‚ùå Rollback Failed</h3>
                <p style="margin: 15px 0;"><strong>Error:</strong> ${error.message}</p>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>‚ö†Ô∏è Important:</strong>
                    <p>The database may be in an inconsistent state. Please:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Check the database status</li>
                        <li>Review Liquibase logs</li>
                        <li>Contact your DBA if needed</li>
                        <li>Consider restoring from backup</li>
                    </ul>
                </div>
                <button class="confirm-no" onclick="cancelRollback()" style="margin-top: 15px;">
                    Close
                </button>
            </div>
        `;
    }
}

function cancelRollback() {
    const confirmDialog = document.getElementById('rollbackConfirm');
    const confirmText = document.getElementById('rollbackConfirmText');
    
    if (confirmDialog) confirmDialog.style.display = 'none';
    if (confirmText) confirmText.innerHTML = '';
}

        function closeRollbackSection() {
            const section = document.getElementById('rollbackSection');
            const confirmDialog = document.getElementById('rollbackConfirm');
            const confirmText = document.getElementById('rollbackConfirmText');
            
            if (section) section.style.display = 'none';
            if (confirmDialog) confirmDialog.style.display = 'none';
            if (confirmText) confirmText.innerHTML = '';
            
            // Refresh the page to show updated data
            handleMigrationComplete();
        }

        // ===== NEW FUNCTIONS FROM Dashboard.jsx =====

        function handleMigrationComplete() {
            refreshAllData();
            refreshKey++;
            loadTabContent(activeTab);
        }

        // Pending Migrations with execute functionality
        let runningMigration = null;
        let showModal = false;
        let modalContent = null;

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event handler for pending migration button clicks (using event delegation)
        // Made global so it can be called from onclick attribute
        window.handlePendingMigrationClick = function(e) {
            const btn = e.target.closest('.run-migration-btn');
            if (!btn || btn.disabled) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Pending migration button clicked', btn);
            
            const container = document.getElementById('pendingMigrations');
            if (!container || !container.dataset.pendingMigrations) {
                console.error('Pending migrations data not found');
                alert('Error: Migration data not found. Please refresh the page.');
                return;
            }
            
            try {
                const index = parseInt(btn.dataset.migrationIndex);
                if (isNaN(index)) {
                    console.error('Invalid migration index:', btn.dataset.migrationIndex);
                    return;
                }
                
                const migrations = JSON.parse(container.dataset.pendingMigrations);
                const migration = migrations[index];
                
                if (migration) {
                    console.log('Button clicked, running migration:', migration);
                    runMigration(migration);
                } else {
                    console.error('Migration not found at index:', index, 'Available migrations:', migrations);
                    alert('Error: Migration not found. Please refresh the page.');
                }
            } catch (error) {
                console.error('Error handling migration click:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // runMigration will be defined later, we'll make it globally accessible there

        async function loadPendingMigrations() {
            const container = document.getElementById('pendingMigrations');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                const response = await fetch(`${API_BASE}/migrations/pending?env=${selectedEnv}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.pending && data.pending.length > 0) {
                        // Store migrations data first
                        container.dataset.pendingMigrations = JSON.stringify(data.pending);
                        
                        // Remove old listener if it exists, then add new one (event delegation)
                        const newHandler = handlePendingMigrationClick;
                        const oldHandler = container._pendingMigrationHandler;
                        if (oldHandler) {
                            container.removeEventListener('click', oldHandler);
                        }
                        container.addEventListener('click', newHandler);
                        container._pendingMigrationHandler = newHandler;
                        
                        container.innerHTML = data.pending.map((migration, index) => `
                            <div class="pending-migration-item" style="margin-bottom: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: #333;">${migration.id}</strong>
                                    ${migration.description ? `<span style="color: #666; margin-left: 8px;">‚Äî ${migration.description}</span>` : ''}
                                </div>
                                <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                                    File: ${migration.filename}
                                </div>
                                <button 
                                    type="button"
                                    class="run-migration-btn"
                                    data-migration-index="${index}"
                                    data-migration-id="${escapeHtml(migration.id)}"
                                    data-migration-author="${escapeHtml(migration.author || '')}"
                                    data-migration-filename="${escapeHtml(migration.filename || '')}"
                                    data-migration-description="${escapeHtml(migration.description || '')}"
                                    ${runningMigration === migration.id ? 'disabled' : ''}
                                    onclick="handlePendingMigrationClick(event)"
                                    style="padding: 6px 12px; background-color: ${runningMigration === migration.id ? '#ccc' : '#007bff'}; color: white; border: none; border-radius: 4px; cursor: ${runningMigration === migration.id ? 'not-allowed' : 'pointer'};"
                                >
                                    ${runningMigration === migration.id ? 'Running...' : 'Run'}
                                </button>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div style="padding: 12px; color: #666;">
                                No pending migrations
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `<div class="error-message">${data.error || 'Failed to load pending migrations'}</div>`;
                }
            } catch (error) {
                console.error('Error loading pending migrations:', error);
                container.innerHTML = `<div class="error-message">Error loading pending migrations: ${error.message}</div>`;
            }
        }

        async function runMigration(migration) {
            if (!migration) {
                console.error('runMigration called with no migration object');
                return;
            }
            
            console.log('Running migration:', migration);
            
            const confirmMsg = `Execute migration "${migration.id}" (${migration.description || migration.filename}) on ${selectedEnv.toUpperCase()}?`;
            if (!window.confirm(confirmMsg)) return;
            
            runningMigration = migration.id;
            await loadPendingMigrations();
            
            try {
                let changelogFile = migration.filename;
                if (!changelogFile.startsWith('changelogs/')) {
                    changelogFile = `changelogs/${changelogFile}`;
                }
                
                console.log('Calling API:', `${API_BASE}/migrations/execute`, { env: selectedEnv, changelogFile: changelogFile });
                
                const response = await fetch(`${API_BASE}/migrations/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ env: selectedEnv, changelogFile: changelogFile })
                });
                
                const r = await response.json();
                
                if (!response.ok || !r.success) {
                    // Create an error object with response data
                    const error = new Error(r.error || `HTTP ${response.status}: ${response.statusText}`);
                    error.response = { data: r };
                    throw error;
                }
                
                if (r.success) {
                    const output = r.output || '';
                    const warnings = r.warnings || '';
                    const fullOutput = warnings ? `${output}\n\n--- Warnings ---\n${warnings}` : output;
                    
                    showModalDialog(
                        `Migration "${migration.id}" completed`,
                        fullOutput || 'Migration executed successfully (no output)',
                        false
                    );
                    
                    await loadPendingMigrations();
                    handleMigrationComplete();
                } else {
                    throw new Error(r.error || 'Migration failed');
                }
            } catch (error) {
                console.error('Migration error:', error);
                let errorMsg = error.message || 'Unknown error';
                let errorOutput = '';
                let errorStderr = '';
                
                // Try to extract error details from response
                if (error.response && error.response.data) {
                    const errorData = error.response.data;
                    errorMsg = errorData.error || errorMsg;
                    errorOutput = errorData.stdout || '';
                    errorStderr = errorData.stderr || '';
                } else if (error.message && error.message.includes('fetch')) {
                    // Network error
                    errorMsg = 'Network error: Could not connect to API server. Please check if the backend is running.';
                }
                
                // Parse Liquibase error output to extract key information
                let parsedError = errorMsg;
                if (errorStderr) {
                    // Extract the main error reason from Liquibase output
                    const reasonMatch = errorStderr.match(/ERROR: Exception Primary Reason:\s*(.+)/);
                    const classMatch = errorStderr.match(/ERROR: Exception Primary Class:\s*(.+)/);
                    const sourceMatch = errorStderr.match(/ERROR: Exception Primary Source:\s*(.+)/);
                    
                    if (reasonMatch || classMatch) {
                        parsedError = `‚ùå Migration Failed\n\n`;
                        if (reasonMatch) parsedError += `Reason: ${reasonMatch[1]}\n`;
                        if (classMatch) parsedError += `Error Type: ${classMatch[1]}\n`;
                        if (sourceMatch) parsedError += `Database: ${sourceMatch[1]}\n`;
                        parsedError += `\n--- Full Error Details ---\n${errorStderr}`;
                    } else {
                        parsedError = errorStderr;
                    }
                } else if (errorOutput) {
                    parsedError = errorOutput;
                }
                
                showModalDialog(
                    `Migration "${migration.id}" failed`,
                    parsedError,
                    true
                );
            } finally {
                runningMigration = null;
                await loadPendingMigrations();
            }
        }

        // Migration Timeline with search and rollback functionality
        let expandedItems = new Set();
        let rollingBackId = null;
        let timelineSearchTerm = '';

        async function loadMigrationTimeline() {
            const container = document.getElementById('migrationTimeline');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                const response = await fetch(`${API_BASE}/migrations/history?env=${selectedEnv}&limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    renderTimelineForTab(data.history, container);
                } else {
                    container.innerHTML = '<div class="error-message">Failed to load migration history</div>';
                }
            } catch (error) {
                console.error('Error loading migration timeline:', error);
                container.innerHTML = '<div class="error-message">Error loading migration timeline</div>';
            }
        }

        function renderTimelineForTab(history, container) {
            container.innerHTML = '';
            
            // Add search box
            const searchBox = document.createElement('div');
            searchBox.style.marginBottom = '12px';
            searchBox.innerHTML = `
                <input
                    type="text"
                    id="timelineSearch"
                    placeholder="Search migrations..."
                    value="${timelineSearchTerm}"
                    oninput="filterTimeline()"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                />
            `;
            container.appendChild(searchBox);
            
            // Filter history
            const filteredHistory = history.filter(h => {
                if (!timelineSearchTerm) return true;
                const term = timelineSearchTerm.toLowerCase();
                return (
                    (h.ID || '').toLowerCase().includes(term) ||
                    (h.AUTHOR || '').toLowerCase().includes(term) ||
                    (h.FILENAME || '').toLowerCase().includes(term) ||
                    (h.DESCRIPTION || '').toLowerCase().includes(term)
                );
            });
            
            if (!filteredHistory || filteredHistory.length === 0) {
                container.innerHTML += '<div style="padding: 12px; color: #666; text-align: center;">' +
                    (timelineSearchTerm ? 'No migrations match your search' : 'No migration history') +
                    '</div>';
                return;
            }

            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';
            list.style.margin = '0';
            list.style.maxHeight = '400px';
            list.style.overflow = 'auto';
            
            filteredHistory.forEach(h => {
                const isExpanded = expandedItems.has(h.ORDEREXECUTED);
                const li = document.createElement('li');
                li.style.padding = '12px';
                li.style.borderBottom = '1px solid #eee';
                li.style.backgroundColor = isExpanded ? '#f9f9f9' : 'white';
                li.style.cursor = 'pointer';
                
                li.onclick = () => toggleExpand(h.ORDEREXECUTED);
                
                li.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div><strong>${h.ID}</strong> ‚Äî ${h.DESCRIPTION || h.FILENAME}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                by ${h.AUTHOR} ‚Ä¢ ${h.DATEEXECUTED ? new Date(h.DATEEXECUTED).toLocaleString() : 'N/A'}
                            </div>
                        </div>
                        <div style="font-size: 20px; color: #999;">
                            ${isExpanded ? '‚ñº' : '‚ñ∂'}
                        </div>
                    </div>
                    ${isExpanded ? `
                        <div style="margin-top: 12px; padding: 12px; background-color: white; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; font-family: monospace;">
                            <div><strong>Order:</strong> ${h.ORDEREXECUTED}</div>
                            <div style="margin-top: 4px;"><strong>Filename:</strong> ${h.FILENAME}</div>
                            ${h.MD5SUM ? `<div style="margin-top: 4px;"><strong>MD5:</strong> ${h.MD5SUM}</div>` : ''}
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
                                <button
                                    class="rollback-changeset-btn"
                                    data-changeset-id="${h.ID}"
                                    data-changeset-author="${h.AUTHOR || ''}"
                                    data-changeset-filename="${h.FILENAME || ''}"
                                    data-changeset-order="${h.ORDEREXECUTED || ''}"
                                    disabled="${rollingBackId === h.ID}"
                                    style="padding: 6px 12px; background-color: ${rollingBackId === h.ID ? '#ccc' : '#dc3545'}; color: white; border: none; border-radius: 4px; cursor: ${rollingBackId === h.ID ? 'not-allowed' : 'pointer'}; font-size: 12px; font-weight: bold;"
                                >
                                    ${rollingBackId === h.ID ? 'Rolling back...' : 'Rollback'}
                                </button>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                list.appendChild(li);
            });
            
            container.appendChild(list);
            
            // Store history data for later use
            container.dataset.migrationHistory = JSON.stringify(filteredHistory);
            
            // Add event listeners to rollback buttons
            container.querySelectorAll('.rollback-changeset-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const history = JSON.parse(container.dataset.migrationHistory);
                    const migration = history.find(m => m.ID === this.dataset.changesetId);
                    if (migration) {
                        handleRollback(migration);
                    }
                });
            });
        }

        function toggleExpand(orderExecuted) {
            if (expandedItems.has(orderExecuted)) {
                expandedItems.delete(orderExecuted);
            } else {
                expandedItems.add(orderExecuted);
            }
            loadMigrationTimeline();
        }

        function filterTimeline() {
            timelineSearchTerm = document.getElementById('timelineSearch').value;
            loadMigrationTimeline();
        }

        async function handleRollback(migration) {
            if (!migration) {
                console.error('handleRollback called with no migration object');
                return;
            }
            
            console.log('Rolling back migration:', migration);
            
            const confirmMsg = `Are you sure you want to rollback changeset "${migration.ID}" in ${selectedEnv.toUpperCase()}?\n\nThis action cannot be undone.`;
            if (!window.confirm(confirmMsg)) return;
            
            rollingBackId = migration.ID;
            await loadMigrationTimeline();
            
            try {
                console.log('Calling API:', `${API_BASE}/migrations/rollback-one`, {
                    env: selectedEnv,
                    changesetId: migration.ID,
                    author: migration.AUTHOR,
                    filename: migration.FILENAME
                });
                
                const response = await fetch(`${API_BASE}/migrations/rollback-one`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        env: selectedEnv,
                        changesetId: migration.ID,
                        author: migration.AUTHOR,
                        filename: migration.FILENAME
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}: ${response.statusText}` }));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const r = await response.json();
                
                if (r.success) {
                    const output = r.output || '';
                    const warnings = r.warnings || '';
                    const fullOutput = warnings ? `${output}\n\n--- Warnings ---\n${warnings}` : output;
                    
                    showModalDialog(
                        `Rollback "${migration.ID}" completed`,
                        fullOutput || 'Rollback executed successfully',
                        false
                    );
                    
                    await loadMigrationTimeline();
                    handleMigrationComplete();
                } else {
                    throw new Error(r.error || 'Rollback failed');
                }
            } catch (error) {
                console.error('Rollback error:', error);
                let errorMsg = error.message || 'Unknown error';
                let errorOutput = '';
                let errorStderr = '';
                
                // Try to extract error details if available
                if (error.response) {
                    try {
                        const errorData = await error.response.json();
                        errorMsg = errorData.error || errorMsg;
                        errorOutput = errorData.stdout || '';
                        errorStderr = errorData.stderr || '';
                    } catch (e) {
                        // Ignore JSON parse errors
                    }
                }
                
                const fullError = errorOutput || errorStderr ? 
                    `${errorMsg}\n\n--- Output ---\n${errorOutput}\n\n--- Error Details ---\n${errorStderr}` : 
                    errorMsg;
                
                showModalDialog(
                    `Rollback "${migration.ID}" failed`,
                    fullError,
                    true
                );
            } finally {
                rollingBackId = null;
                await loadMigrationTimeline();
            }
        }

        // Metrics Dashboard
        async function loadMetricsDashboard() {
            const container = document.getElementById('metricsDashboard');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                const response = await fetch(`${API_BASE}/metrics`);
                const metrics = await response.json();
                
                if (metrics.success) {
                    container.innerHTML = `
                        <h2 style="margin-top: 0;">Metrics Dashboard</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #007bff;">${metrics.totalMigrations}</div>
                                <div style="color: #666; margin-top: 8px;">Total Migrations</div>
                            </div>
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #28a745;">${metrics.appliedPerEnv.dev || 0}</div>
                                <div style="color: #666; margin-top: 8px;">Applied (DEV)</div>
                            </div>
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #28a745;">${metrics.appliedPerEnv.qa || 0}</div>
                                <div style="color: #666; margin-top: 8px;">Applied (QA)</div>
                            </div>
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #28a745;">${metrics.appliedPerEnv.prod || 0}</div>
                                <div style="color: #666; margin-top: 8px;">Applied (PROD)</div>
                            </div>
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #ffc107;">${metrics.pendingPerEnv.dev || 0}</div>
                                <div style="color: #666; margin-top: 8px;">Pending (DEV)</div>
                            </div>
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #ffc107;">${metrics.pendingPerEnv.qa || 0}</div>
                                <div style="color: #666; margin-top: 8px;">Pending (QA)</div>
                            </div>
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #ffc107;">${metrics.pendingPerEnv.prod || 0}</div>
                                <div style="color: #666; margin-top: 8px;">Pending (PROD)</div>
                            </div>
                            <div class="card" style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #dc3545;">${metrics.rollbacksExecuted || 0}</div>
                                <div style="color: #666; margin-top: 8px;">Rollbacks Executed</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="error-message">Error loading metrics</div>';
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
                container.innerHTML = '<div class="error-message">Error loading metrics dashboard</div>';
            }
        }

        // Version Map
        async function loadVersionMap() {
            const container = document.getElementById('versionMap');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                const response = await fetch(`${API_BASE}/version-map`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.versionMap.length === 0) {
                        container.innerHTML = '<div class="card"><p style="text-align:center;color:#666;padding:20px;">No version map data available</p></div>';
                        return;
                    }
                    
                    let html = `
                        <div class="card">
                            <h3 style="margin-top: 0;">Version Comparison Matrix</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Changeset</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Description</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">DEV</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">QA</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">PROD</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    data.versionMap.forEach(row => {
                        html += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; border: 1px solid #ddd;">
                                    <strong>${row.changeset}</strong>
                                    <div style="font-size: 11px; color: #666;">by ${row.author}</div>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${row.description || row.filename}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${row.dev ? '‚úî' : '‚úñ'}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${row.qa ? '‚úî' : '‚úñ'}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${row.prod ? '‚úî' : '‚úñ'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error-message">Failed to load version map</div>';
                }
            } catch (error) {
                console.error('Error loading version map:', error);
                container.innerHTML = '<div class="error-message">Error loading version map</div>';
            }
        }

        // Rollback History
        async function loadRollbackHistory() {
            const container = document.getElementById('rollbackHistory');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                const response = await fetch(`${API_BASE}/rollbacks/history${selectedEnv ? '?env=' + selectedEnv : ''}`);
                const data = await response.json();
                
                if (data.success) {
                    const allRollbacks = [];
                    Object.entries(data).forEach(([envName, rollbacks]) => {
                        if (Array.isArray(rollbacks)) {
                            rollbacks.forEach(r => {
                                allRollbacks.push({...r, env: r.env || envName});
                            });
                        }
                    });
                    
                    allRollbacks.sort((a, b) => new Date(b.rolled_back_at || b.executed_at) - new Date(a.rolled_back_at || a.executed_at));
                    
                    if (allRollbacks.length === 0) {
                        container.innerHTML = '<div class="card"><p style="text-align:center;color:#666;padding:20px;">No rollback history</p></div>';
                        return;
                    }
                    
                    let html = `
                        <div class="card">
                            <h3 style="margin-top: 0;">Rollback History ${selectedEnv ? `(${selectedEnv.toUpperCase()})` : '(All Environments)'}</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Environment</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Changeset</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Author</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Filename</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Rollback Tag</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Rolled Back At</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    allRollbacks.forEach(r => {
                        html += `
                            <tr>
                                <td style="padding: 12px; border: 1px solid #ddd;">${r.env.toUpperCase()}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>${r.changeset_id || r.tag}</strong></td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${r.author || 'N/A'}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${r.filename || 'N/A'}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${r.rollback_tag || r.tag || 'N/A'}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${new Date(r.rolled_back_at || r.executed_at).toLocaleString()}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">
                                    <span style="padding: 4px 8px; border-radius: 4px; background-color: ${r.status === 'SUCCESS' ? '#d4edda' : '#f8d7da'}; color: ${r.status === 'SUCCESS' ? '#155724' : '#721c24'}; font-size: 12px; font-weight: bold;">
                                        ${r.status || 'N/A'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error-message">Failed to load rollback history</div>';
                }
            } catch (error) {
                console.error('Error loading rollback history:', error);
                container.innerHTML = '<div class="error-message">Error loading rollback history</div>';
            }
        }

        // Recent Deployments
        async function loadRecentDeployments() {
            const container = document.getElementById('recentDeployments');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                const response = await fetch(`${API_BASE}/deployments/recent?limit=10`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.deployments.length === 0) {
                        container.innerHTML = '<div class="card"><p style="text-align:center;color:#666;padding:20px;">No deployments found</p></div>';
                        return;
                    }
                    
                    let html = `
                        <div class="card">
                            <h3 style="margin-top: 0;">Recent Deployments (Last ${data.deployments.length})</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Environment</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Changeset</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Author</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Description</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Executed At</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    data.deployments.forEach(d => {
                        html += `
                            <tr>
                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>${d.env.toUpperCase()}</strong></td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${d.id}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${d.author}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${d.description || d.filename}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${new Date(d.dateexecuted).toLocaleString()}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">
                                    <span style="padding: 4px 8px; border-radius: 4px; background-color: ${d.status === 'success' ? '#d4edda' : '#f8d7da'}; color: ${d.status === 'success' ? '#155724' : '#721c24'}; font-size: 12px;">
                                        ${d.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error-message">Failed to load recent deployments</div>';
                }
            } catch (error) {
                console.error('Error loading recent deployments:', error);
                container.innerHTML = '<div class="error-message">Error loading recent deployments</div>';
            }
        }

        // Update toggleRollbackSection to show/hide the container
        function toggleRollbackSection() {
            const container = document.getElementById('rollbackSectionContainer');
            const section = document.getElementById('rollbackSection');
            const confirmDialog = document.getElementById('rollbackConfirm');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                section.style.display = 'block';
                if (confirmDialog) confirmDialog.style.display = 'none';
            } else {
                container.style.display = 'none';
                section.style.display = 'none';
                if (confirmDialog) confirmDialog.style.display = 'none';
            }
        }
    </script>
</body>
</html>