<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquibase Migration Dashboard</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üóÑÔ∏è Liquibase Migration Dashboard</h1>
                <p>Monitor and manage database schema changes across all environments</p>
            </div>
           <div class="header-right">
    <div id="connectionStatus" class="connection-status disconnected">
        <span class="status-dot red"></span>
        <span>Disconnected</span>
    </div>
    <button class="refresh-btn" onclick="window.location.href='monitoring.html'">
        <span>üìä</span>
        <span>Monitoring</span>
    </button>
    <button class="refresh-btn" onclick="refreshAllData()" id="refreshBtn">
        <span>üîÑ</span>
        <span>Refresh</span>
    </button>
</div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Changesets</div>
                <div class="stat-value" id="totalChangesets">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle">Across all versions</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Environments</div>
                <div class="stat-value" id="healthyEnvs">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle">Healthy / Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last Deployment</div>
                <div class="stat-value" id="lastDeploy">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle" id="lastDeployEnv">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value" id="successRate">
                    <span class="loading-spinner"></span>
                </div>
                <div class="stat-subtitle">Last 30 days</div>
            </div>
        </div>

        <!-- Environment Status -->
        <div class="environments-section">
            <h2 class="section-title">üìä Environment Status</h2>
            <div class="env-grid" id="envGrid">
                <div class="loading-spinner" style="margin: 50px auto;"></div>
            </div>
        </div>

        <!-- Migration Timeline -->
        <div class="timeline-section">
            <h2 class="section-title">üìÖ Recent Migration History</h2>
            <div class="timeline" id="timeline">
                <div class="loading-spinner" style="margin: 50px auto;"></div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="actions-section">
            <h2 class="section-title">‚ö° Quick Actions</h2>
            <div class="actions-grid">
                <button class="action-button" onclick="viewHistory('dev')">üîç View DEV History</button>
                <button class="action-button" onclick="compareEnvironments()">üìä Compare Environments</button>
                <button class="action-button secondary" onclick="viewHistory('qa')">üß™ View QA History</button>
                <button class="action-button secondary" onclick="viewHistory('prod')">üöÄ View PROD History</button>
            </div>

            <!-- Rollback Section -->
            <div class="rollback-section" style="display: none;" id="rollbackSection">
                <div class="rollback-warning">
                    ‚ö†Ô∏è DANGER ZONE: Database Rollback
                </div>
                <p style="color: #856404; margin-bottom: 15px;">
                    This will undo the last database changes. This action cannot be undone automatically.
                </p>
                <div class="rollback-controls">
                    <label style="font-weight: 600;">Environment:</label>
                    <select id="rollbackEnv" class="filter-select">
                        <option value="dev">DEV</option>
                        <option value="qa">QA</option>
                        <option value="prod">PROD</option>
                    </select>
                    
                    <label style="font-weight: 600;">Changesets to rollback:</label>
                    <input type="number" id="rollbackCount" class="rollback-input" value="1" min="1" max="10">
                    
                    <button class="rollback-btn" onclick="initiateRollback()">
                        ‚èÆÔ∏è Rollback
                    </button>
                </div>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="action-button warning" onclick="toggleRollbackSection()">
                    ‚èÆÔ∏è Show Rollback Options
                </button>
            </div>
        </div>
    </div>

    <!-- Rollback Confirmation Dialog - OUTSIDE container -->
    <div id="rollbackConfirm" class="confirm-dialog" style="display: none;">
        <h3>‚ö†Ô∏è Confirm Rollback</h3>
        <div id="rollbackConfirmText"></div>
        <div class="confirm-buttons">
            <button class="confirm-yes" onclick="executeRollback()">Yes, Rollback</button>
            <button class="confirm-no" onclick="cancelRollback()">Cancel</button>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Migration History</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="search-filter-section">
                <input type="text" id="historySearch" class="search-box"
                       placeholder="üîç Search by ID, author, or description..." oninput="filterHistory()">
                <select id="historyFilter" class="filter-select" onchange="filterHistory()">
                    <option value="all">All Types</option>
                    <option value="EXECUTED">Executed</option>
                    <option value="RERAN">Re-ran</option>
                    <option value="ROLLBACK">Rollback</option>
                </select>
            </div>

            <div id="modalBody">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div class="modal" id="compareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Environment Comparison</h2>
                <button class="close-btn" onclick="closeCompareModal()">&times;</button>
            </div>
            <div id="compareBody">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Liquibase CI/CD Dashboard | Last updated: <span id="lastUpdateTime">Never</span></p>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let environmentsData = [];
        let autoRefreshInterval = null;
        let currentHistoryData = [];
        let rollbackEnvSelected = 'dev';
        let rollbackCountSelected = 1;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            refreshAllData();
            startAutoRefresh();
        });

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                refreshAllData();
            }, 30000);
        }

        async function refreshAllData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            
            try {
                await Promise.all([
                    loadEnvironments(),
                    loadStats(),
                    loadHistory()
                ]);
                
                updateConnectionStatus(true);
                document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error refreshing data:', error);
                updateConnectionStatus(false);
            } finally {
                btn.disabled = false;
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<span class="status-dot green"></span><span>Connected</span>';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<span class="status-dot red"></span><span>Disconnected</span>';
            }
        }

        async function loadEnvironments() {
            try {
                const response = await fetch(`${API_BASE}/environments`);
                const data = await response.json();
                
                if (data.success) {
                    environmentsData = data.environments;
                    renderEnvironments(data.environments);
                }
            } catch (error) {
                console.error('Error loading environments:', error);
                document.getElementById('envGrid').innerHTML = 
                    '<div class="error-message">Failed to load environment data</div>';
            }
        }

        function renderEnvironments(environments) {
            const grid = document.getElementById('envGrid');
            grid.innerHTML = '';

            const icons = { dev: 'üîß', qa: 'üß™', prod: 'üöÄ' };
            const names = { dev: 'DEVELOPMENT', qa: 'QA', prod: 'PRODUCTION' };

            environments.forEach(env => {
                const card = document.createElement('div');
                card.className = 'env-card';
                
                const statusClass = env.status === 'healthy' ? 'status-healthy' : 'status-error';
                const statusText = env.status === 'healthy' ? '‚óè Healthy' : '‚óè Error';
                
                const lastUpdated = env.lastUpdated 
                    ? formatTimeAgo(new Date(env.lastUpdated))
                    : 'Never';

                card.innerHTML = `
                    <div class="env-header">
                        <div class="env-name">${icons[env.environment]} ${names[env.environment]}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="env-info">
                        <div class="info-row">
                            <span class="info-label">Current Version</span>
                            <span class="version-badge">${env.currentVersion || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Changesets Applied</span>
                            <span class="info-value">${env.changesetsApplied || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Last Updated</span>
                            <span class="info-value">${lastUpdated}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Database</span>
                            <span class="info-value">${env.database || 'N/A'}</span>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    document.getElementById('totalChangesets').textContent = stats.totalChangesets;
                    document.getElementById('healthyEnvs').textContent = 
                        `${stats.healthyEnvironments} / ${stats.totalEnvironments}`;
                    document.getElementById('successRate').textContent = `${stats.successRate}%`;
                    
                    if (stats.lastDeployment) {
                        document.getElementById('lastDeploy').textContent = stats.lastDeployment.formatted;
                        document.getElementById('lastDeployEnv').textContent = 'to PROD';
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/migrations/history?env=dev&limit=5`);
                const data = await response.json();
                
                if (data.success) {
                    renderTimeline(data.history);
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('timeline').innerHTML = 
                    '<div class="error-message">Failed to load migration history</div>';
            }
        }

        function renderTimeline(history) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            if (!history || history.length === 0) {
                timeline.innerHTML = '<p style="text-align:center;color:#666;">No migration history available</p>';
                return;
            }

            history.forEach(item => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                const timeAgo = formatTimeAgo(new Date(item.DATEEXECUTED));
                
                timelineItem.innerHTML = `
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-title">${item.ID}</span>
                            <span class="timeline-time">${timeAgo}</span>
                        </div>
                        <div class="timeline-desc">
                            <strong>Author:</strong> ${item.AUTHOR}<br>
                            <strong>Description:</strong> ${item.DESCRIPTION || 'No description'}<br>
                            <strong>File:</strong> ${item.FILENAME}<br>
                            <strong>Status:</strong> ‚úÖ ${item.EXECTYPE}
                        </div>
                    </div>
                `;
                
                timeline.appendChild(timelineItem);
            });
        }

        async function viewHistory(env) {
            const modal = document.getElementById('historyModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            const envNames = { dev: 'DEV', qa: 'QA', prod: 'PROD' };
            modalTitle.textContent = `${envNames[env]} Migration History`;
            
            modal.classList.add('show');
            modalBody.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const response = await fetch(`${API_BASE}/migrations/history?env=${env}&limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    currentHistoryData = data.history;
                    renderHistoryItems(data.history);
                } else {
                    modalBody.innerHTML = '<div class="error-message">Failed to load history</div>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                modalBody.innerHTML = '<div class="error-message">Error loading history: ' + error.message + '</div>';
            }
        }

        function renderHistoryItems(history) {
            const modalBody = document.getElementById('modalBody');
            let html = '';
            
            if (history.length === 0) {
                html = '<p style="text-align:center;color:#666;">No migration history found</p>';
            } else {
                history.forEach(item => {
                    const execTypeBadge = item.EXECTYPE === 'EXECUTED' ? 'badge-success' : 
                                        item.EXECTYPE === 'RERAN' ? 'badge-warning' : 
                                        'badge-info';
                    
                    html += `
                        <div class="history-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4>${item.ID}</h4>
                                <span class="badge ${execTypeBadge}">${item.EXECTYPE}</span>
                            </div>
                            <p><strong>Author:</strong> ${item.AUTHOR}</p>
                            <p><strong>Executed:</strong> ${new Date(item.DATEEXECUTED).toLocaleString()}</p>
                            <p><strong>Description:</strong> ${item.DESCRIPTION || 'No description'}</p>
                            <p><strong>File:</strong> ${item.FILENAME}</p>
                            <p><strong>Order:</strong> #${item.ORDEREXECUTED}</p>
                        </div>
                    `;
                });
            }
            
            modalBody.innerHTML = html;
        }

        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const filterType = document.getElementById('historyFilter').value;
            
            let filtered = currentHistoryData;
            
            if (filterType !== 'all') {
                filtered = filtered.filter(item => item.EXECTYPE === filterType);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.ID.toLowerCase().includes(searchTerm) ||
                    item.AUTHOR.toLowerCase().includes(searchTerm) ||
                    (item.DESCRIPTION && item.DESCRIPTION.toLowerCase().includes(searchTerm)) ||
                    item.FILENAME.toLowerCase().includes(searchTerm)
                );
            }
            
            renderHistoryItems(filtered);
        }

        async function compareEnvironments() {
            const modal = document.getElementById('compareModal');
            const compareBody = document.getElementById('compareBody');
            
            modal.classList.add('show');
            compareBody.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const response = await fetch(`${API_BASE}/migrations/diff?env1=dev&env2=prod`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<h3>Schema Comparison: DEV vs PROD</h3>';
                    
                    html += `
                        <div style="margin: 20px 0;">
                            <p><strong>DEV:</strong> ${data.environment1.totalChangesets} changesets</p>
                            <p><strong>PROD:</strong> ${data.environment2.totalChangesets} changesets</p>
                        </div>
                    `;
                    
                    if (data.differences.identical) {
                        html += '<div class="success-message">‚úÖ Environments are identical</div>';
                    } else {
                        if (data.differences.onlyIn.dev.length > 0) {
                            html += '<h4 style="color:#667eea;margin-top:20px;">Only in DEV:</h4>';
                            html += '<ul>';
                            data.differences.onlyIn.dev.forEach(id => {
                                html += `<li>${id}</li>`;
                            });
                            html += '</ul>';
                        }
                        
                        if (data.differences.onlyIn.prod.length > 0) {
                            html += '<h4 style="color:#667eea;margin-top:20px;">Only in PROD:</h4>';
                            html += '<ul>';
                            data.differences.onlyIn.prod.forEach(id => {
                                html += `<li>${id}</li>`;
                            });
                            html += '</ul>';
                        }
                    }
                    
                    compareBody.innerHTML = html;
                } else {
                    compareBody.innerHTML = '<div class="error-message">Failed to compare environments</div>';
                }
            } catch (error) {
                console.error('Error comparing environments:', error);
                compareBody.innerHTML = '<div class="error-message">Error: ' + error.message + '</div>';
            }
        }

        function closeModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        function closeCompareModal() {
            document.getElementById('compareModal').classList.remove('show');
        }

        window.onclick = function(event) {
            const historyModal = document.getElementById('historyModal');
            const compareModal = document.getElementById('compareModal');
            
            if (event.target === historyModal) {
                closeModal();
            }
            if (event.target === compareModal) {
                closeCompareModal();
            }
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
                }
            }
            
            return 'Just now';
        }

        // ===== ROLLBACK FUNCTIONS - FINAL FIXED VERSION =====

        function toggleRollbackSection() {
            const section = document.getElementById('rollbackSection');
            const confirmDialog = document.getElementById('rollbackConfirm');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (confirmDialog) confirmDialog.style.display = 'none';
            } else {
                section.style.display = 'none';
                if (confirmDialog) confirmDialog.style.display = 'none';
            }
        }

     // Replace these functions in your index.html <script> section

async function initiateRollback() {
    const env = document.getElementById('rollbackEnv').value;
    const count = parseInt(document.getElementById('rollbackCount').value);
    
    rollbackEnvSelected = env;
    rollbackCountSelected = count;
    
    // First, get preview of what will be rolled back
    try {
        const response = await fetch(`${API_BASE}/migrations/rollback-preview?env=${env}&count=${count}`);
        const previewData = await response.json();
        
        if (!previewData.success) {
            alert('Error getting rollback preview: ' + previewData.error);
            return;
        }

        const confirmDialog = document.getElementById('rollbackConfirm');
        const confirmText = document.getElementById('rollbackConfirmText');
        
        const envNames = { dev: 'DEVELOPMENT', qa: 'QA', prod: 'PRODUCTION' };
        
        let html = `
            <p><strong>‚ö†Ô∏è You are about to rollback ${count} changeset(s) from ${envNames[env]}</strong></p>
        `;
        
        if (env === 'prod') {
            html += `<div class="prod-warning">‚ö†Ô∏è CRITICAL: THIS IS PRODUCTION ENVIRONMENT!</div>`;
        }
        
        html += `<div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin-bottom: 10px;">Changesets to be rolled back:</h4>`;
        
        previewData.changesetsToRollback.forEach((cs, index) => {
            html += `
                <div style="padding: 8px; margin: 5px 0; background: white; border-left: 3px solid #dc3545; border-radius: 4px;">
                    <strong>${index + 1}. ${cs.ID}</strong><br>
                    <small>Author: ${cs.AUTHOR} | ${new Date(cs.DATEEXECUTED).toLocaleString()}</small><br>
                    <small>${cs.DESCRIPTION || 'No description'}</small>
                </div>
            `;
        });
        
        html += `</div>
            <p style="color: #721c24; font-weight: 600; margin-top: 15px;">
                ‚ö†Ô∏è This action CANNOT be undone automatically. Make sure you have a backup!
            </p>
            <p style="color: #856404;">
                Current changesets: ${previewData.changesetsToRollback[0]?.ORDEREXECUTED || 'Unknown'} ‚Üí 
                After rollback: ${(previewData.changesetsToRollback[0]?.ORDEREXECUTED || 0) - count}
            </p>`;
        
        confirmText.innerHTML = html;
        confirmDialog.style.display = 'block';
        confirmDialog.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function executeRollback() {
    const confirmDialog = document.getElementById('rollbackConfirm');
    confirmDialog.innerHTML = `
        <div style="text-align: center; padding: 30px;">
            <div class="loading-spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
            <h3>Executing Rollback...</h3>
            <p style="color: #666;">Please wait. This may take a few moments.</p>
        </div>
    `;
    
    try {
        const response = await fetch(`${API_BASE}/migrations/rollback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                env: rollbackEnvSelected,
                count: rollbackCountSelected
            })
        });

        const data = await response.json();
        
        if (data.success) {
            confirmDialog.innerHTML = `
                <div class="success-message">
                    <h3>‚úÖ Rollback Completed Successfully</h3>
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p><strong>Environment:</strong> ${data.environment.toUpperCase()}</p>
                        <p><strong>Changesets Rolled Back:</strong> ${data.changesetsRolledBack}</p>
                        <p><strong>Before:</strong> ${data.changesetsBefore} changesets</p>
                        <p><strong>After:</strong> ${data.changesetsAfter} changesets</p>
                        ${data.currentChangeset ? `
                            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                                <strong>Current Changeset:</strong><br>
                                ${data.currentChangeset.ID}<br>
                                <small>by ${data.currentChangeset.AUTHOR}</small>
                            </div>
                        ` : ''}
                    </div>
                    <details style="margin: 15px 0;">
                        <summary style="cursor: pointer; font-weight: 600; color: #667eea;">
                            View Command Output
                        </summary>
                        <pre style="background: #f4f4f4; padding: 15px; border-radius: 6px; overflow-x: auto; margin-top: 10px; font-size: 0.85em;">
${data.output || 'No output available'}</pre>
                    </details>
                    <button class="confirm-no" onclick="closeRollbackSection()" style="margin-top: 15px;">
                        Close
                    </button>
                </div>
            `;
            
            // Refresh dashboard data
            setTimeout(() => refreshAllData(), 1500);
        } else {
            throw new Error(data.error || 'Rollback failed');
        }
        
    } catch (error) {
        confirmDialog.innerHTML = `
            <div class="error-message">
                <h3>‚ùå Rollback Failed</h3>
                <p style="margin: 15px 0;"><strong>Error:</strong> ${error.message}</p>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>‚ö†Ô∏è Important:</strong>
                    <p>The database may be in an inconsistent state. Please:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Check the database status</li>
                        <li>Review Liquibase logs</li>
                        <li>Contact your DBA if needed</li>
                        <li>Consider restoring from backup</li>
                    </ul>
                </div>
                <button class="confirm-no" onclick="cancelRollback()" style="margin-top: 15px;">
                    Close
                </button>
            </div>
        `;
    }
}

function cancelRollback() {
    const confirmDialog = document.getElementById('rollbackConfirm');
    const confirmText = document.getElementById('rollbackConfirmText');
    
    if (confirmDialog) confirmDialog.style.display = 'none';
    if (confirmText) confirmText.innerHTML = '';
}

function closeRollbackSection() {
    const section = document.getElementById('rollbackSection');
    const confirmDialog = document.getElementById('rollbackConfirm');
    const confirmText = document.getElementById('rollbackConfirmText');
    
    if (section) section.style.display = 'none';
    if (confirmDialog) confirmDialog.style.display = 'none';
    if (confirmText) confirmText.innerHTML = '';
    
    // Refresh the page to show updated data
    refreshAllData();
}
    </script>
</body>
</html>