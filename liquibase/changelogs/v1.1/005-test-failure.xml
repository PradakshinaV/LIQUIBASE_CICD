<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
       http://www.liquibase.org/xml/ns/dbchangelog
       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.23.xsd">

    <!-- ============================================ -->
    <!-- WORKING CHANGESETS                           -->
    <!-- ============================================ -->

    <!-- CHANGESET 1: Adds created_at timestamp column -->
    <changeSet id="005-add-created-date" author="admin">
        <addColumn tableName="users">
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <rollback>
            <dropColumn tableName="users" columnName="created_at"/>
        </rollback>
    </changeSet>

    <!-- CHANGESET 2: Adds updated_at timestamp column with ON UPDATE -->
    <changeSet id="005-add-updated-date" author="admin">
        <addColumn tableName="users">
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <rollback>
            <dropColumn tableName="users" columnName="updated_at"/>
        </rollback>
    </changeSet>

    <!-- CHANGESET 3: Add ON UPDATE to updated_at column -->
    <changeSet id="005-add-onupdate-to-updated-at" author="admin">
        <sql>
            ALTER TABLE users 
            MODIFY COLUMN updated_at TIMESTAMP 
            DEFAULT CURRENT_TIMESTAMP 
            ON UPDATE CURRENT_TIMESTAMP 
            NOT NULL;
        </sql>
        <rollback>
            <sql>
                ALTER TABLE users 
                MODIFY COLUMN updated_at TIMESTAMP 
                DEFAULT CURRENT_TIMESTAMP 
                NOT NULL;
            </sql>
        </rollback>
    </changeSet>

    <!-- ============================================ -->
    <!-- INTENTIONAL FAILURE CHANGESET - FOR TESTING  -->
    <!-- ============================================ -->
    <!-- 
    
    ⚠️ TESTING AUTOMATIC ROLLBACK ⚠️
    
    This changeset is intentionally designed to FAIL.
    It attempts to add a column to a table that doesn't exist.
    
    PURPOSE:
    - Test automatic rollback in CI/CD pipeline
    - Verify failure detection works
    - Ensure database returns to previous state
    
    TO TEST AUTOMATIC ROLLBACK:
    1. Uncomment the changeset below (remove the comment tags)
    2. Save the file
    3. Commit and push to GitHub
    4. Watch the pipeline fail and automatically rollback
    5. After testing, COMMENT IT BACK OUT to restore working pipeline
    
    ============================================
    -->
    
    <!--
    <changeSet id="005-intentional-failure" author="admin">
        <comment>
            This changeset intentionally fails because 'non_existent_table' does not exist.
            Used for testing automatic rollback functionality.
        </comment>
        <addColumn tableName="non_existent_table">
            <column name="test_column" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <rollback>
            <dropColumn tableName="non_existent_table" columnName="test_column"/>
        </rollback>
    </changeSet>
    -->

</databaseChangeLog>